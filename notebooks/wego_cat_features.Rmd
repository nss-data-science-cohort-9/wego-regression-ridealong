---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}



```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
library(tidyverse)
# install for visualizations 
library(ggplot2)
# install to combine date and time
library(lubridate)
# for melting a df
library(reshape)
wego <- read_csv("../data/Route 50 Timepoint and Headway Data, 1-1-2023 through 5-12-2025.csv")

```
```{r}
wego
```

```{r}
# Create new date time column
wego$DATE_TIME <- ymd(wego$DATE) + hms(wego$SCHEDULED_TIME)

# Examine Data
wego
```

```{r}


# Filter February TSP values
feb3_10_tsp <- wego |> 
  filter(between(DATE_TIME, 
                 as.Date("2025-02-03 12:00:00"), 
                 as.Date("2025-02-10 12:00:00")))

# Filter Feb-Apr TSP with buses only 2 minutes late or more
feb10_apr28_tsp <- wego |> 
  filter(between(DATE_TIME, 
                 as.Date("2025-02-10 12:00:00"), 
                 as.Date("2025-04-28 12:00:00")))

# Filter May TSP values
may5_12_tsp <- wego |> 
  filter(between(DATE_TIME, 
                 as.Date("2025-05-05 12:00:00"), 
                 as.Date("2025-05-12 12:00:00")))

may12_tsp <- wego |> 
  filter(DATE_TIME > as.Date("2025-05-12 12:00:00"))

  
```




```{r}

# Add day of week column
wego <- wego |>
  mutate(
    DATE_TIME = as.POSIXct(DATE_TIME),
    DAY_OF_WEEK = wday(DATE_TIME, 
                       label = TRUE, 
                       abbr = FALSE))

wego

```


```{r}

# Combine tsp variables into one 
tsp_rows <- bind_rows(
  feb3_10_tsp,
  feb10_apr28_tsp,
  may5_12_tsp,
  may12_tsp
) |> 
  select('ADHERENCE_ID', 'DATE_TIME') |> 
  distinct() |> 
  mutate(tsp = 1)  # Add tsp indicator column for each distinct adherence id

wego <- wego |> 
  left_join(
    tsp_rows,
    by = c('ADHERENCE_ID', 'DATE_TIME')
  ) |> 
  mutate(tsp = coalesce(tsp, 0))

```


```{r}

wego #|> view()


```


```{r}

# wego <- wego |>  mutate(
#   tsp_indicator = if_else(
#     between(DATE_TIME, 
#             as.Date("2025-02-03 12:00:00"), 
#             as.Date("2025-02-10 12:00:00")) |
#     (between(DATE_TIME, 
#             as.Date("2025-02-10 12:00:00"), 
#             as.Date("2025-04-28 12:00:00")) &
#        ADHERENCE <= -2) |
#     between(DATE_TIME, 
#             as.Date("2025-05-05 12:00:00"), 
#             as.Date("2025-05-12 12:00:00")), 1, 0)
#     
#   )
# 
# wego

```

```{r}
wego <- wego |> mutate(
  HOUR = hms(SCHEDULED_TIME) |> 
    hour()
  )

```

```{r}

wego <- wego |>
  mutate(
    time_of_day = case_when(
      between(HOUR, 4, 5) ~ "early_morning",
      between(HOUR, 6, 8) ~ "morning_peak",
      between(HOUR, 9, 14) ~ "midday",
      between(HOUR, 15, 17) ~ "pm_peak",
      between(HOUR, 18, 20) ~ "evening",
      between(HOUR, 21, 23) ~ "late_night",
      between(HOUR, 0, 3) ~ "late_night",
      .default = "other"
    )
  )

wego

```

```{r}

tod_table = table(wego$time_of_day)
pt_tod_table <- prop.table(tod_table)

pt_tod_table
tod_table
```


```{r}

barplot(table(wego$time_of_day), main = "Time of day distribution")

```


```{r}

table_tod <- pt_tod_table 
# Create a color vector
color <- rainbow(nrow(table_tod))
# Set the rotation for x-axis labels to 45 degrees
par(las=2)
# Create the vertically stacked bar plot
bp <- barplot(table_tod, main = "Time of day distribution", col = color)
# Add the legend
legend("topright", legend = rownames(table_tod),cex = 0.75, fill = color)
# Add x-axis labels with a 45 degree angle
# axis(1, at=bp, labels=colnames(table_tod), las=2, cex.axis=2)

```


```{r}

late_tod <- table(wego$time_of_day, wego$ADJUSTED_LATE_COUNT)
# Create a color vector
color <- rainbow(nrow(late_tod))
# Set the rotation for x-axis labels to 45 degrees
par(las=2)
# Create the vertically stacked bar plot
bp <- barplot(late_tod, main = "Late bus dist", col = color)
# Add the legend
legend("topright", legend = rownames(late_tod),cex = 0.9, fill = color)
# Add x-axis labels with a 45 degree angle
axis(1, at=bp, labels=colnames(late_tod), las=2, cex.axis=1)

```
```{r}
count_tod <- wego |>
  count(time_of_day)

count_tod
```

```{r}
unique(wego$ADJUSTED_LATE_COUNT)
```
```{r}
wego
```


```{r}
# count_tod <- wego |>
#   count(time_of_day)
# # value <- count_tod$n
# value = count_tod
#   # table(wego$time_of_day)
# condition <- tod <- c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "late_night", "other") #wego$time_of_day
# specie <- wego$ADJUSTED_LATE_COUNT
# 
# ggplot(wego, aes(fill=condition, y=value, x=specie)) + 
#     geom_bar(position="fill", stat="identity")



```


```{r}

wego_tod_count_late <- wego |> 
  group_by(time_of_day, ADJUSTED_LATE_COUNT) |> 
  summarize(n = n())


wego_tod_count_late
```
```{r}
wego$time_of_day <- factor(wego$time_of_day, levels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")) 
```


```{r}

ggplot(wego_tod_count_late, aes(fill=time_of_day, y=n, x=factor(ADJUSTED_LATE_COUNT))) + 
  geom_bar(position="fill", stat="identity")+ 
  xlab("Ontime (0) and Late (1) Buses") +
  ylab("Proportion of Buses") +
  ggtitle("Ontime and Late Buses Based on Time of Day")

```


```{r}

time_day_log <- glm(ADJUSTED_LATE_COUNT ~ tsp * time_of_day,
                    data = wego,
                    family = "binomial")

summary(time_day_log)

```


```{r}

# wego$time_of_day <- factor(wego$time_of_day, levels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")) 

# wego$time_of_day <- relevel(wego$time_of_day, "early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")

tod_plot <- ggplot(wego_tod_count_late, 
       aes(fill = factor(time_of_day, levels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")),
       y=n, 
       x=factor(ADJUSTED_LATE_COUNT))) + 
  geom_bar(position="fill", stat="identity", color="black") + 
  labs(title = "Buses Often Run Late During the PM Peak", x = "", y = "Proportion of Buses", fill = "Time of Day") +
  scale_x_discrete(labels=c("ontime", "late")) +
  scale_fill_manual(labels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other"), values = c("#191919", "#f3e4ee", "khaki", "#b4eef0", "#e3fafb", "#b5ffd0", "grey")) +
  theme(plot.title = element_text(hjust = 0.5))

tod_plot
```

```{r}
# dev.copy(tod_plot, 'time_of_day_orig.pdf')
# # dev.off()
ggsave("time_of_day_orig.png", plot = tod_plot, width=8, height=5, dpi=300)
```


```{r}



```


```{r}
```

```{r}

time_day_log <- glm(ADJUSTED_LATE_COUNT ~ tsp * time_of_day,
                    data = wego,
                    family = "binomial")

summary(time_day_log)


```


```{r}

lgrgmdl_tod <- coef(summary(time_day_log))

lgrgmdl_tod

```
```{r}

```

```{r}
summary(time_day_log)$coefficients[3, 1]

```



```{r}

lg_tod_table <- as_tibble(rownames_to_column(data.frame(lgrgmdl_tod)))

lg_tod_table["tsp_indicator"] = c(0,1,0,0,0,0,0,1,1,1,1,1)
```


```{r}


```

```{r}
lg_tod_table
```

```{r}

plot <- ggplot(lg_tod_table, aes(factor(rowname), Estimate, fill = factor(tsp_indicator))) + 
  geom_bar(stat="identity", position = "dodge") + 
  scale_fill_brewer(palette = "Set1")

plot

ggsave("attempt_plot.png", plot = plot)
```

```{r}
lg_tod_table |>
  group_by(tsp_indicator, Estimate) |>
  ggplot(ggplot2::aes(rowname, Estimate)) +
  geom_bar(ggplot2::aes(fill = tsp_indicator), position = "dodge", stat="identity")

```
```{r}
lg_tod_limted <- lg_tod_table |> slice(c(-1,-2))

lg_tod_limted
```


```{r}

lg_tod_table |>
  gather(tsp_indicator, Estimate, -rowname) |>
  ggplot(aes(x=rowname, y=Estimate, fill=tsp_indicator)) +
   geom_col(position = "dodge")

```


```{r}

prob_late_tod <- wego |> 
  group_by(time_of_day, tsp) |>
  summarize(mean_adj_late_count = mean(ADJUSTED_LATE_COUNT)) 

prob_late_tod

```

```{r}

wego |>
  group_by(time_of_day, tsp) |>
  summarise(mean(ADJUSTED_LATE_COUNT))
  

```

```{r}

time_day_log <- glm(ADJUSTED_LATE_COUNT ~ tsp * time_of_day,
                    data = wego,
                    family = "binomial")

summary(time_day_log)

```


```{r}

tsp_tod <- with(wego, data.frame(time_of_day = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night"), tsp=1))

tsp_on_tod <- predict(time_day_log, tsp_tod, type="response")

prcnt_tsp_on_tod <- tsp_on_tod*100
prcnt_tsp_on_tod
```


```{r}

tod_affect <- with(wego, data.frame(time_of_day = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night"), tsp=0))

tod_alone <- predict(time_day_log, tod_affect, type="response")

prcnt_tsp_alone <- tod_alone*100
prcnt_tsp_alone
# pred <- tod_alone$fit
plot(tod_alone, type="l", ylab="Predicted Probability to Vote", xlab="Age", bty="n")
```

```{r}
tod_alone
```

```{r}

df <- cbind.data.frame("time_of_day" = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night"),  "tsp_on" = tod_alone, "tod_w_tsp" = tsp_tod)

barplot(height = c(df$tsp_on, df$tod_w_tsp),
    names.arg = df$time_of_day,
    main = "With and Without TSP, TIME OF DAY",
    xlab = "Time of Day",
    ylab = "Probability of Late Buses",
    col = c("#191919", "#f3e4ee", "khaki", "#b4eef0", "#e3fafb", "#b5ffd0", "grey"),
    las = 2)

```


```{r}

sbs_tod_tsp <- rbind(prcnt_tsp_alone,prcnt_tsp_on_tod)
sbs_tod_tsp
barplot(sbs_tod_tsp,beside=T)

sbs_tod_tsp_rn <- cbind(rownames_list = rownames(sbs_tod_tsp), sbs_tod_tsp)
sbs_tod_tsp_rn

```
```{r}


tod_affect <- with(wego, data.frame(time_of_day = c("early_morning", "early_morning", "morning_peak", "morning_peak", "midday", "midday", "pm_peak", "pm_peak", "evening", "evening", "late_night", "late_night"), tsp=0))

tod_alone <- predict(time_day_log, tod_affect, type="response")

prcnt_tsp_alone <- tod_alone*100
prcnt_tsp_alone
# pred <- tod_alone$fit
plot(tod_alone, type="l", ylab="Predicted Probability to Vote", xlab="Age", bty="n")

```

```{r}
tod_affect
```


```{r}


```


```{r}
mid_tod_tsp <- list(
  c( time_of_day = "early_morning", tsp = 0),
  c( time_of_day = "early_morning", tsp = 1),
  c( time_of_day = "morning_peak", tsp = 0),
  c( time_of_day = "morning_peak", tsp = 1),
  c( time_of_day = "midday", tsp = 0),
  c( time_of_day = "midday", tsp = 1),
  c( time_of_day = "pm_peak", tsp = 0),
  c( time_of_day = "pm_peak", tsp = 1),
  c( time_of_day = "evening", tsp = 0),
  c( time_of_day = "evening", tsp = 1),
  c( time_of_day = "late_night", tsp = 0),
  c( time_of_day = "late_night", tsp = 1)
  )
mid_tod_tsp



```
```{r}

middle_tod_tsp <- bind_rows(mid_tod_tsp)

middle_tod_tsp

middle_tod_tsp <- middle_tod_tsp |>
  mutate(tsp = as.numeric(tsp))

```
```{r}
wego
```

```{r}
# mid_tod_tsp
tod_stand_alone <- predict(time_day_log, middle_tod_tsp, type="response")
tod_stand_alone
```

```{r}

middle_tod_tsp <- middle_tod_tsp |>
  mutate(Probs = tod_stand_alone)
  
```


```{r}

probs_tod_tsp <- ggplot(middle_tod_tsp,
       aes(x=fct_relevel(time_of_day, c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night")), y=Probs,
           fill=factor(tsp)
           )
       ) +
  geom_bar(position="dodge", stat="identity", color="black") + 
  labs(title = "The Effect of TSP on the Probability of Buses Being Late", x = "time_of_day", y = "Probability of Buses Being Late", fill = "tsp") +
  scale_fill_manual(labels = c("tsp_off", "tsp_on"), values = c("#b4eef0", "khaki")) +
  theme(plot.title = element_text(hjust = 0.5))


probs_tod_tsp


```
```{r}

Probs_tod_tsp_notitle <- ggplot(middle_tod_tsp,
       aes(x=fct_relevel(time_of_day, c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night")), y=Probs,
           fill=factor(tsp)
           )
       ) +
  geom_bar(position="dodge", stat="identity", color="black") + 
  labs(title = "", x = "time_of_day", y = "Probability of Buses Being Late", fill = "tsp") +
  scale_fill_manual(labels = c("tsp_off", "tsp_on"), values = c("#b4eef0", "khaki")) +
  theme(plot.title = element_text(hjust = 0.5))


Probs_tod_tsp_notitle


```


```{r}

ggsave("probs_lt_tsp_tod_nttl.png", plot = Probs_tod_tsp_notitle, width=8, height=5, dpi=300)

ggsave("probs_lt_tsp_tod.png", plot = probs_tod_tsp, width=8, height=5, dpi=300)
```


```{r}


time_day_log <- glm(ADJUSTED_LATE_COUNT ~ tsp * time_of_day * day_of_week,
                    data = wego,
                    family = "binomial")

summary(time_day_log)


```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```

