---
title: "wego_transit_analysis"
output:
  html_document: default
  pdf_document: default
date: "2026-01-15"
---

```{r}
library(tidyverse)
library(dplyr)
library(lubridate)

wego <- read_csv("../data/Route 50 Timepoint and Headway Data, 1-1-2023 through 5-12-2025.csv")
```
>
>
> ### Data Preperation
>
>
> This project is a comprehensive study of Transit Signal Priority and its effect on Wego public transit. We want to see if TSP has an effect on Nashville public transit. The first thing we want to do is create a variable so we can filter for the dates and times that TSP was active. To do this we will borrow from a package called "lubridate". This will enable us to create a time and date column which we can then use to filter our data.
>
>
>* Create datetime and day of week column
>* Add indicator column for TSP variable
>* Incorporate hour column to create time of day feature.
>
>

```{r}
# Create new date time column
wego$DATE_TIME <- ymd(wego$DATE) + hms(wego$SCHEDULED_TIME)

```

```{r}
# Add day of week column
wego <- wego |>
  mutate(
    DATE_TIME = as.POSIXct(DATE_TIME),
    DAY_OF_WEEK = wday(DATE_TIME, 
                       label = TRUE, 
                       abbr = FALSE))

```

```{r}

# Build indicator column for TSP time-frames
wego <- wego |>  mutate(
  tsp_indicator = if_else(
    between(DATE_TIME, 
            as.Date("2025-02-03 12:00:00"), 
            as.Date("2025-02-10 12:00:00")) |
    between(DATE_TIME, 
            as.Date("2025-02-10 12:00:00"), 
            as.Date("2025-04-28 12:00:00")) |
    between(DATE_TIME, 
            as.Date("2025-05-05 12:00:00"), 
            as.Date("2025-05-12 12:00:00")), 1, 0)
  )

```

```{r}
# Add hour column to data
wego_hr <- wego |> mutate(
  HOUR_COLUMN = hms(SCHEDULED_TIME) |> 
    hour()
  )

```
>
>
> ### Data Cleaning
>
>
> The hour column was generated by scheduled times for busses. Because there are N/A values and messy data in this column we must make the values in scheduled time uniform. Below we investigate the columns in "SCHEDULED_TIME" that are causing the issue. We come to find that some of these variables have additional numbers, unuseful for our analysis.
>
>
>* Locate issue in new column.
>* Correct scheduled time values.
>* Rerun operation and create time of day feature.
>
>

```{r}
# View ocurrences obscured by N/A values
wego_hr[is.na(wego_hr$HOUR_COLUMN),]

```

```{r}
# Adjust SCHEDULED_TIME values to be consistent throughout column
wego_hr$SCHEDULED_TIME = str_sub(
  wego_hr$SCHEDULED_TIME, 
  start = -8, 
  end = -1
  )

# Save to original dataframe
wego_hr <- wego |> mutate(
  HOUR_COLUMN = hms(SCHEDULED_TIME) |> 
    hour()
  )

```

```{r}
# Add time of day feature with hour column
wego_hr <- wego_hr |> mutate(
  time_of_day = case_when(
    HOUR_COLUMN >= 4 & HOUR_COLUMN < 6  ~ 'early_morning',
    HOUR_COLUMN >= 6 & HOUR_COLUMN < 9  ~ 'morning_peak',
    HOUR_COLUMN >= 9 & HOUR_COLUMN < 15 ~ 'midday',
    HOUR_COLUMN >= 15 & HOUR_COLUMN < 18 ~ 'pm_peak',
    HOUR_COLUMN >= 18 & HOUR_COLUMN < 21 ~ 'evening',
    TRUE ~ 'late_night')
  )

```

```{r}
# Show proportion of late buses by time of day
wego_hr |> 
  group_by(time_of_day) |> 
  summarize(mean(ADJUSTED_LATE_COUNT))
  
```



```{r}
# Fit logistic regression model based on tsp
wego_log_reg <- glm(ADJUSTED_LATE_COUNT ~ tsp_indicator,
                    data = wego,
                    family = "binomial")
summary(wego_log_reg)

```

```{r}
# Show percentage of late stops without tsp
predict(object = wego_log_reg, 
        newdata = data.frame(tsp_indicator = 0), 
        type= 'response') 

```

```{r}
# # Show percentage of late stops with tsp
predict(object = wego_log_reg, 
        newdata = data.frame(tsp_indicator = 1), 
        type= 'response') 

```

```{r}
# Fit model based on time of day
glm(ADJUSTED_LATE_COUNT ~ time_of_day,
                    data = wego_hr,
                    family = "binomial")
```

```{r}
# Add indicator column to data frame with features
wego_hr <- wego_hr |>  mutate(
  tsp_indicator = if_else(
    between(DATE_TIME, 
            as.Date("2025-02-03 12:00:00"), 
            as.Date("2025-02-10 12:00:00")) |
    between(DATE_TIME, 
            as.Date("2025-02-10 12:00:00"), 
            as.Date("2025-04-28 12:00:00")) |
    between(DATE_TIME, 
            as.Date("2025-05-05 12:00:00"), 
            as.Date("2025-05-12 12:00:00")), 1, 0)
  )

```






```{r}
# Create multivariable model
log_reg_multi <- glm(ADJUSTED_LATE_COUNT ~ tsp_indicator + time_of_day + DAY_OF_WEEK + HOUR_COLUMN,
                    data = wego_hr,
                    family = "binomial")
```

```{r}
summary(log_reg_multi)
```



```{r}

# Plot Average late count by time of day
late_prop_by_time <- wego_hr |>
  group_by(time_of_day) |>
  summarize(mean_late_count = mean(ADJUSTED_LATE_COUNT)) 


ggplot(late_prop_by_time, aes(x = time_of_day, y = mean_late_count)) +
  geom_col(fill = "#b5ffd0", color = "black") + 
  labs(
    title = "Average Late Count by Time of Day",
    x = "Time of Day",
    y = "Late Count Proportion"
  )

```

```{r}
# Save plot to computer and adjust paramaters for powerpoint
avg_late_count_by_day <- ggplot(late_prop_by_time, aes(x = time_of_day, y = mean_late_count)) +
  geom_col(fill = "#b5ffd0", color = "black") + 
  labs(
    title = "Average Late Count by Time of Day",
    x = "Time of Day",
    y = "Late Count Proportion"
  )

ggsave(
  filename = "avg_late_count_by_day.png",
  plot = avg_late_count_by_day,
  width = 8,
  height = 5,
  dpi = 300
)
```


```{r}
# PLot average late count by day of week
late_prop_by_time <- wego_hr |>
  group_by(DAY_OF_WEEK) |>
  summarize(mean_late_count = mean(ADJUSTED_LATE_COUNT)) 


ggplot(late_prop_by_time, aes(x = DAY_OF_WEEK, y = mean_late_count, na.rm = TRUE)) +
  geom_col(fill = "#b5ffd0", color = "black") + 
  labs(
    title = "Average Late Count by Day of Week",
    x = "Day of Week",
    y = "Late Count Proportion"
  )

```

```{r}
# Save plot to computer and adjust paramaters for powerpoint
avg_day_late_count <- ggplot(late_prop_by_time, aes(x = DAY_OF_WEEK, y = mean_late_count, na.rm = TRUE)) +
  geom_col(fill = "#b5ffd0", color = "black") + 
  labs(
    title = "Average Late Count by Day of Week",
    x = "Day of Week",
    y = "Late Count Proportion"
  )

ggsave(
  filename = "avg_day_late_count.png",
  plot = avg_day_late_count,
  width = 8, # Set width for powerpoint
  height = 5, # Set height for powerpoint
  dpi = 300 # Adjust dot per inch
)

```

```{r}
# Create count of late and on time busses for each category
wego_tod_count_late <- wego_hr |> 
  group_by(time_of_day, ADJUSTED_LATE_COUNT) |> 
  summarize(n = n())

```

```{r}
# Change variables to categorical
wego_hr$time_of_day <- factor(wego_hr$time_of_day, levels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")) 
```

```{r}
# Plot proportional bar chart showing time of day differences
tod_plot <- ggplot(wego_tod_count_late, 
       aes(fill = factor(time_of_day, levels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other")),
       y=n, 
       x=factor(ADJUSTED_LATE_COUNT))) + 
  geom_bar(position="fill", stat="identity", color="black") + 
  labs(title = "Buses Often Run Late During the PM Peak", x = "", y = "Proportion of Buses", fill = "Time of Day") +
  scale_x_discrete(labels=c("ontime", "late")) +
  scale_fill_manual(labels = c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night", "other"), values = c("#191919", "#f3e4ee", "khaki", "#b4eef0", "#e3fafb", "#b5ffd0", "grey")) +
  theme(plot.title = element_text(hjust = 0.5))

tod_plot
```

```{r}
# Save plot to computer
ggsave(
  "time_of_day_orig.png", 
  plot = tod_plot, width=8, 
  height=5, 
  dpi=300
  )
```

```{r}
mid_tod_tsp <- list(
  c( time_of_day = "early_morning", tsp = 0),
  c( time_of_day = "early_morning", tsp = 1),
  c( time_of_day = "morning_peak", tsp = 0),
  c( time_of_day = "morning_peak", tsp = 1),
  c( time_of_day = "midday", tsp = 0),
  c( time_of_day = "midday", tsp = 1),
  c( time_of_day = "pm_peak", tsp = 0),
  c( time_of_day = "pm_peak", tsp = 1),
  c( time_of_day = "evening", tsp = 0),
  c( time_of_day = "evening", tsp = 1),
  c( time_of_day = "late_night", tsp = 0),
  c( time_of_day = "late_night", tsp = 1)
  )
```


```{r}
tod_stand_alone <- predict(
  time_day_log, 
  middle_tod_tsp, 
  type="response"
  )
```


```{r}
middle_tod_tsp <- middle_tod_tsp |>
  mutate(Probs = tod_stand_alone)
```


```{r}
probs_tod_tsp <- ggplot(middle_tod_tsp,
       aes(x=fct_relevel(time_of_day, c("early_morning", "morning_peak", "midday", "pm_peak", "evening", "late_night")), y=Probs,
           fill=factor(tsp)
           )
       ) +
  geom_bar(position="dodge", stat="identity", color="black") + 
  labs(title = "The Effect of TSP on the Probability of Buses Being Late", x = "time_of_day", y = "Probability of Buses Being Late", fill = "tsp") +
  scale_fill_manual(labels = c("tsp_off", "tsp_on"), values = c("#b4eef0", "khaki")) +
  theme(plot.title = element_text(hjust = 0.5))


probs_tod_tsp
```






